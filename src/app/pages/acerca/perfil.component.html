<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-borgona" role="status">
    <span class="visually-hidden">Cargando...</span>
  </div>
</div>

<div *ngIf="!loading && perfil">
  <h2 class="text-borgona mb-4">Perfil de investigadora o investigador</h2>

  <form (ngSubmit)="guardarCambios()" #perfilForm="ngForm">
    <div class="row">
      <!-- Columna izquierda: Foto y currículum -->
      <div class="col-lg-4 mb-4">
        <div class="card mb-3">
          <div class="card-header bg-light text-borgona fw-bold">Fotografía</div>
          <div class="card-body text-center">
            <div *ngIf="fotoPreview" class="mb-3">
              <img [src]="fotoPreview" alt="Foto de perfil" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
            </div>
            <div *ngIf="!fotoPreview" class="profile-pic-placeholder mb-3" style="min-height: 200px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; border-radius: 8px;">
              <span class="text-muted">Sube tu fotografía para el perfil</span>
            </div>
            <input type="file" class="form-control mt-2" accept="image/*" (change)="onFotoChange($event)" aria-describedby="fotoHelp">
            <div id="fotoHelp" class="form-text muted-small">JPG/PNG; recomendado 400x400px. Máximo 10MB.</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-light text-borgona fw-bold">Currículum</div>
          <div class="card-body">
            <div *ngIf="curriculumPreview" class="mb-3">
              <div class="d-flex align-items-center gap-2 mb-2">
                <img src="assets/img/documentos.png" alt="PDF" style="width:24px;height:24px;">
                <span>{{ curriculumPreview }}</span>
              </div>
              <button *ngIf="perfil.curriculumDocumentoId" type="button" class="btn btn-sm btn-outline-primary" (click)="descargarCurriculum()">
                Descargar Curriculum
              </button>
            </div>
            <div *ngIf="!curriculumPreview" class="curriculum-placeholder mb-3" style="min-height: 100px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; border-radius: 8px;">
              <span class="text-muted">Sube tu currículum en PDF para el perfil</span>
            </div>
            <input type="file" class="form-control" accept=".pdf" (change)="onCurriculumChange($event)" aria-describedby="cvHelp">
            <div id="cvHelp" class="form-text muted-small">PDF; máximo 10 MB.</div>
          </div>
        </div>
      </div>

      <!-- Columna derecha: Datos y tags -->
      <div class="col-lg-8">
        <!-- Visibilidad en módulo de investigadoras e investigadores -->
        <div class="card mb-3">
          <div class="card-header bg-light text-borgona fw-bold">Visibilidad en el módulo de investigadoras e investigadores</div>
          <div class="card-body">
            <p class="text-muted small mb-3">Elige qué información de tu trayectoria se mostrará de forma pública en el directorio. Puedes guardar esta preferencia en cualquier momento; no es necesario haber completado todo el formulario de «Completar registro».</p>
            <div class="d-flex flex-wrap gap-2">
              <button type="button"
                class="btn rounded-pill px-3 py-2 visibility-btn"
                [class.btn-borgona]="perfil.visibilidadPerfil === 'MINIMA'"
                [class.btn-outline-secondary]="perfil.visibilidadPerfil !== 'MINIMA'"
                (click)="elegirVisibilidad('MINIMA')">
                Mínima
              </button>
              <button type="button"
                class="btn rounded-pill px-3 py-2 visibility-btn"
                [class.btn-borgona]="perfil.visibilidadPerfil === 'ESTANDAR'"
                [class.btn-outline-secondary]="perfil.visibilidadPerfil !== 'ESTANDAR'"
                (click)="elegirVisibilidad('ESTANDAR')">
                Estándar
              </button>
              <button type="button"
                class="btn rounded-pill px-3 py-2 visibility-btn"
                [class.btn-borgona]="perfil.visibilidadPerfil === 'COMPLETA'"
                [class.btn-outline-secondary]="perfil.visibilidadPerfil !== 'COMPLETA'"
                (click)="elegirVisibilidad('COMPLETA')">
                Completa
              </button>
            </div>
            <div class="mt-2 small text-muted">
              <span *ngIf="perfil.visibilidadPerfil === 'MINIMA'"><strong>Mínima:</strong> Solo nombre completo y grado académico (sin correo, foto, CV ni trayectoria).</span>
              <span *ngIf="perfil.visibilidadPerfil === 'ESTANDAR'"><strong>Estándar:</strong> Nombre, grado, correo y foto; idiomas e herramientas de tu trayectoria (sin teléfono, semblanza, CV, cursos, logros ni artículos).</span>
              <span *ngIf="perfil.visibilidadPerfil === 'COMPLETA'"><strong>Completa:</strong> Toda la información de tu perfil y trayectoria: contacto, semblanza, CV, cursos, idiomas, herramientas, logros y artículos.</span>
            </div>
          </div>
        </div>

        <!-- Grado Académico -->
        <div class="card mb-3">
          <div class="card-header bg-light text-borgona fw-bold">Grado Académico</div>
          <div class="card-body">
            <div class="input-group">
              <span class="input-group-text bg-light border-borgona" id="icon-cedula">
                <img src="assets/img/user.png" alt="Icono grado académico" style="width:18px;height:18px;">
              </span>
              <input type="text" class="form-control input-custom" disabled [value]="perfil.gradoAcademico || 'No especificado'" aria-describedby="icon-cedula">
            </div>
          </div>
        </div>

        <!-- Correo -->
        <div class="card mb-3">
          <div class="card-header bg-light text-borgona fw-bold">Correo</div>
          <div class="card-body">
            <div class="input-group has-validation">
              <span class="input-group-text bg-light border-borgona" id="icon-correo">
                <img src="assets/img/correo.png" alt="Icono correo" style="width:18px;height:18px;">
              </span>
              <input type="email" class="form-control input-custom" disabled [value]="perfil.email" aria-describedby="icon-correo">
            </div>
          </div>
        </div>

        <!-- Datos de Identificación -->
        <div class="card mb-3">
          <div class="card-header bg-light text-borgona fw-bold">Datos de Identificación</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label visually-hidden" for="nombre">Nombre</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-borgona">
                    <img src="assets/img/user.png" alt="Icono nombre" style="width:18px;height:18px;">
                  </span>
                  <input type="text" id="nombre" name="nombre" class="form-control input-custom" disabled [value]="perfil.nombre">
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label visually-hidden" for="apellido_paterno">Apellido Paterno</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-borgona">
                    <img src="assets/img/user.png" alt="Icono apellido" style="width:18px;height:18px;">
                  </span>
                  <input type="text" id="apellido_paterno" name="apellido_paterno" class="form-control input-custom" disabled [value]="perfil.apellidoPaterno">
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label visually-hidden" for="apellido_materno">Apellido Materno</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-borgona">
                    <img src="assets/img/user.png" alt="Icono apellido" style="width:18px;height:18px;">
                  </span>
                  <input type="text" id="apellido_materno" name="apellido_materno" class="form-control input-custom" disabled [value]="perfil.apellidoMaterno">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CURP, RFC y Género -->
        <div class="card mb-3">
          <div class="card-header bg-light text-borgona fw-bold">CURP, RFC y Género</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label visually-hidden" for="curp">CURP</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-borgona">
                    <img src="assets/img/id.png" alt="Icono CURP" style="width:18px;height:18px;">
                  </span>
                  <input type="text" id="curp" name="curp" class="form-control input-custom" disabled [value]="perfil.curp">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label visually-hidden" for="rfc">RFC</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-borgona">
                    <img src="assets/img/id.png" alt="Icono RFC" style="width:18px;height:18px;">
                  </span>
                  <input type="text" id="rfc" name="rfc" class="form-control input-custom" disabled [value]="perfil.rfc">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label visually-hidden" for="fechaNacimiento">Fecha de Nacimiento</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-borgona">
                    <img src="assets/img/calendario.png" alt="Icono fecha" style="width:18px;height:18px;">
                  </span>
                  <input type="text" id="fechaNacimiento" name="fechaNacimiento" class="form-control input-custom" disabled [value]="formatearFecha(perfil.fechaNacimiento)">
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label visually-hidden" for="genero">Género</label>
                <div class="input-group">
                  <span class="input-group-text bg-light border-borgona">
                    <img src="assets/img/genero.png" alt="Icono género" style="width:18px;height:18px;">
                  </span>
                  <input type="text" id="genero" name="genero" class="form-control input-custom" disabled [value]="formatearGenero(perfil.genero)">
                </div>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- /col derecha -->
    </div> <!-- /row -->

    <!-- Acciones -->
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-borgona px-4 d-flex align-items-center gap-2 justify-content-center mx-auto" [disabled]="uploading">
        <img src="assets/img/guardar.png" alt="" style="width:18px;height:18px;"> 
        <span *ngIf="!uploading">Guardar cambios</span>
        <span *ngIf="uploading">Guardando...</span>
      </button>
    </div>
  </form>
</div>
